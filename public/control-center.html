<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MyBank Control Center</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial;padding:16px;max-width:1000px;margin:auto}
    input,button,select{padding:8px;margin:6px 0;display:block;width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:6px}
    .row{display:flex;gap:8px}
    .row input{flex:1}
  </style>
</head>
<body>
  <h1>MyBank Control Center</h1>
  <div id="login">
    <input id="adminUser" placeholder="Admin username" value="mywebhosting">
    <input id="adminPass" placeholder="Admin password" type="password" value="password123">
    <button onclick="adminLogin()">Login</button>
  </div>

  <div id="control" style="display:none">
    <div class="row">
      <button onclick="loadUsers()">Load users</button>
      <button onclick="loadTransactions()">Load transactions</button>
      <button onclick="loadBroadcasts()">Load broadcasts</button>
    </div>

    <h3>Create user</h3>
    <input id="c_user" placeholder="username">
    <input id="c_pass" placeholder="password" type="password">
    <input id="c_bal" placeholder="initial balance" type="number" value="0">
    <label><input type="checkbox" id="c_isadmin"> is admin</label>
    <button onclick="adminCreateUser()">Create user</button>

    <h3>Users</h3>
    <div id="usersWrap"></div>

    <h3>Transactions</h3>
    <div id="txWrap"></div>

    <h3>Broadcast</h3>
    <input id="b_msg" placeholder="message">
    <button onclick="adminBroadcast()">Send Broadcast</button>
    <div id="b_out"></div>
  </div>

<script>
const BACKEND_URL = location.origin;
let adminCreds = {};

function showError(e){ alert(e); }

async function adminLogin(){
  const adminUsername = document.getElementById('adminUser').value;
  const adminPassword = document.getElementById('adminPass').value;
  const res = await fetch(BACKEND_URL + '/api/admin/login', {
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ adminUsername, adminPassword })
  });
  const d = await res.json();
  if(d.success){ adminCreds = { adminUsername, adminPassword }; document.getElementById('login').style.display='none'; document.getElementById('control').style.display='block'; }
  else showError(d.error||JSON.stringify(d));
}

async function loadUsers(){
  const res = await fetch(BACKEND_URL + '/api/admin/users', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(adminCreds)
  });
  const d = await res.json();
  if(d.error) return showError(d.error);
  const wrap = document.getElementById('usersWrap');
  wrap.innerHTML = `<table><thead><tr><th>Username</th><th>Balance</th><th>Admin</th><th>Frozen</th><th>Actions</th></tr></thead><tbody>${
    d.map(u=>`<tr><td>${escapeHtml(u.username)}</td><td>${u.balance}</td><td>${u.is_admin}</td><td>${u.is_frozen}</td><td>
      <button onclick="showSet('${u.username}')">Set Balance</button>
      <button onclick="toggleFreeze('${u.username}', ${u.is_frozen ? 'false' : 'true'})">${u.is_frozen ? 'Unfreeze' : 'Freeze'}</button>
      <button onclick="adminDeleteUser('${u.username}')">Delete</button>
    </td></tr>`).join('')
  }</tbody></table>`;
}

function showSet(username){
  const val = prompt('Set new balance for ' + username);
  if(val===null) return;
  adminSetBalance(username, Number(val));
}

async function adminSetBalance(username, balance){
  const res = await fetch(BACKEND_URL + '/api/admin/setBalance', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({}, adminCreds, { username, balance }))
  });
  const d = await res.json();
  if(d.success){ alert('Done'); loadUsers(); } else showError(d.error);
}

async function toggleFreeze(username, freeze){
  const res = await fetch(BACKEND_URL + '/api/admin/freezeUser', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({}, adminCreds, { username, freeze }))
  });
  const d = await res.json();
  if(d.success){ alert('Done'); loadUsers(); } else showError(d.error);
}

async function adminDeleteUser(username){
  if(!confirm('Delete '+username+'?')) return;
  const res = await fetch(BACKEND_URL + '/api/admin/deleteUser', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({}, adminCreds, { username }))
  });
  const d = await res.json();
  if(d.success){ alert('Deleted'); loadUsers(); } else showError(d.error);
}

async function adminCreateUser(){
  const username = document.getElementById('c_user').value.trim();
  const password = document.getElementById('c_pass').value;
  const balance = Number(document.getElementById('c_bal').value||0);
  const is_admin = document.getElementById('c_isadmin').checked;
  const res = await fetch(BACKEND_URL + '/api/admin/createUser', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({}, adminCreds, { username, password, balance, is_admin }))
  });
  const d = await res.json();
  if(d.success){ alert('Created'); loadUsers(); } else showError(d.error);
}

async function loadTransactions(){
  const res = await fetch(BACKEND_URL + '/api/admin/transactions', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(adminCreds)
  });
  const d = await res.json();
  const wrap = document.getElementById('txWrap');
  if(d.error) return showError(d.error);
  wrap.innerHTML = `<table><thead><tr><th>When</th><th>Sender</th><th>Receiver</th><th>Amount</th></tr></thead><tbody>${
    d.map(t=>`<tr><td>${new Date(t.created_at).toLocaleString()}</td><td>${escapeHtml(t.sender||'—')}</td><td>${escapeHtml(t.receiver||'—')}</td><td>${t.amount}</td></tr>`).join('')
  }</tbody></table>`;
}

async function loadBroadcasts(){
  const res = await fetch(BACKEND_URL + '/api/broadcasts');
  const d = await res.json();
  document.getElementById('b_out').innerHTML = d.map(b=>`<div><small>${new Date(b.created_at).toLocaleString()} — ${escapeHtml(b.message)}</small></div>`).join('');
}

async function adminBroadcast(){
  const message = document.getElementById('b_msg').value;
  const res = await fetch(BACKEND_URL + '/api/admin/broadcast', {
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({}, adminCreds, { message }))
  });
  const d = await res.json();
  if(d.success){ alert('Broadcast sent'); loadBroadcasts(); } else showError(d.error);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
